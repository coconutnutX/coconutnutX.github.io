<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="coconutnut">
    
    <title>
        
            TCLocks Note |
        
        CoCoNutNut&#39;s NoteBook
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/avatar.png">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"coconutnutx.github.io","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"rgb(70,179,119)","avatar":"/images/avatar.jpg","favicon":"/images/avatar.png","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"background_img":"/images/panorama1.jpg","description":"The cave you fear to enter holds the treasure you seek."},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":true},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="CoCoNutNut's NoteBook" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                CoCoNutNut&#39;s NoteBook
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">TCLocks Note</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">coconutnut</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2023-09-14 12:09:23
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Note/">Note</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/lock/">lock</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p><a class="link"   target="_blank" rel="noopener" href="https://rs3lab.github.io/assets/papers/2023/gupta:tclocks.pdf" >paper<i class="fas fa-external-link-alt"></i></a> <a class="link"   target="_blank" rel="noopener" href="https://github.com/rs3lab/TCLocks" >repo<i class="fas fa-external-link-alt"></i></a></p>
<h1 id="Repo-structure"><a href="#Repo-structure" class="headerlink" title="Repo structure"></a>Repo structure</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">├── scripts                           </span><br><span class="line">│   ├── run-*-benchmark.sh         // run benchmarks(host)</span><br><span class="line">│   └── run-vm.sh                  // run VM(host)</span><br><span class="line">└── src</span><br><span class="line">    ├── defaults.sh                // configure VM cores</span><br><span class="line">    ├── benchmarks</span><br><span class="line">    ├── kernel</span><br><span class="line">    │   ├── linux-5.14.16</span><br><span class="line">    │   └── rcuht</span><br><span class="line">    │       ├── rcuht.c            // lock interface</span><br><span class="line">    │       ├── run-rcuht-*.sh     // run rcuhashbash test(guest, called by benchmarks)</span><br><span class="line">    │       ├── include</span><br><span class="line">    │       │   ├── lib</span><br><span class="line">    │       │   ├── mutex</span><br><span class="line">    │       │   ├── rwlock</span><br><span class="line">    │       │   ├── rwsem</span><br><span class="line">    │       │   └── spinlock</span><br><span class="line">    │       ├── lib</span><br><span class="line">    │       ├── locks              // lock implementation</span><br><span class="line">    │       └── script</span><br><span class="line">    └── userspace</span><br></pre></td></tr></table></figure>



<h1 id="TCLock-implementation"><a href="#TCLock-implementation" class="headerlink" title="TCLock implementation"></a>TCLock implementation</h1><p>Listing 1 in paper</p>
<p>code: komb.h, komb.c</p>
<h2 id="spin-lock"><a href="#spin-lock" class="headerlink" title="spin_lock"></a>spin_lock</h2><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/2023/screencapture2023-09-14 PM12.20.06.jpg"
                      width=500
                >

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">komb_spin_lock(struct qspinlock *lock)</span><br><span class="line">&#123;</span><br><span class="line">	u32 val, cnt;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">komb_node</span> *<span class="title">curr_node</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Try to acquire TAS lock</span></span><br><span class="line">	val = atomic_cmpxchg_acquire(&amp;lock-&gt;val, <span class="number">0</span>, _Q_LOCKED_VAL);</span><br><span class="line">  <span class="comment">//                                    expected value: 0, new value: _Q_LOCKED_VAL</span></span><br><span class="line">  <span class="comment">// if &amp;lock-&gt;val is 0: &amp;lock-&gt;val = 0, val = 0</span></span><br><span class="line">  <span class="comment">// if &amp;lock-&gt;val is not 0:             val = &amp;lock-&gt;val</span></span><br><span class="line">	<span class="keyword">if</span> (val == <span class="number">0</span>)</span><br><span class="line">    <span class="comment">// Got the lock, return directly, then execute critical setion</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  curr_node = this_cpu_ptr(&amp;komb_nodes[<span class="number">0</span>]);</span><br><span class="line">  <span class="comment">// Begin slow path function</span></span><br><span class="line">  komb_spin_lock_slowpath(lock); <span class="comment">// Switch stack in this function</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="switch-stack"><a href="#switch-stack" class="headerlink" title="switch_stack"></a>switch_stack</h2><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/2023/screencapture2023-09-14 PM2.32.19.jpg"
                      width=500
                >

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">komb_spin_lock_slowpath(struct qspinlock *lock)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">register</span> <span class="keyword">int</span> ret_val;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 26 switch_to_ephemeral_stack(cst.node) # Main → ephemeral stack</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Inline assembly</span></span><br><span class="line">  <span class="comment">// push register values to stack</span></span><br><span class="line">	<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;pushq %%rbp\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="string">&quot;pushq %%rbx\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="string">&quot;pushq %%r12\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="string">&quot;pushq %%r13\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="string">&quot;pushq %%r14\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="string">&quot;pushq %%r15\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     :</span></span></span><br><span class="line"><span class="params"><span class="function">		     :</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="comment">// indicate this inline assembly may affect memory</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     : <span class="string">&quot;memory&quot;</span>)</span></span>; </span><br><span class="line">	<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    		 <span class="comment">// call function get_komb_node</span></span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="comment">// %P0 is a placeholder for the first input operation</span></span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="comment">// will be replaced by the address of funtion get_komb_node</span></span></span></span><br><span class="line"><span class="params"><span class="function">    		 <span class="string">&quot;callq %P0\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    		 <span class="comment">// move the value of stack pointer &#x27;rsp&#x27; to &#x27;%c1(%%rax)&#x27;</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="string">&quot;movq %%rsp, %c1(%%rax)\n&quot;</span> </span></span></span><br><span class="line"><span class="params"><span class="function">		     :</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="comment">// indicate the value of input parameter %P0, %c1</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     : <span class="string">&quot;i&quot;</span>(get_komb_node), <span class="string">&quot;i&quot;</span>(offsetof(struct komb_node, rsp))</span></span></span><br><span class="line"><span class="params"><span class="function">		     : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    		 <span class="comment">// call function get_shadow_stack_ptr</span></span></span></span><br><span class="line"><span class="params"><span class="function">    		 <span class="string">&quot;callq %P0\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    		 <span class="comment">// use the value in &#x27;rax&#x27; as address, get a value, and save to &#x27;rsp&#x27;</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="string">&quot;movq (%%rax), %%rsp\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">		     :</span></span></span><br><span class="line"><span class="params"><span class="function">		     : <span class="string">&quot;i&quot;</span>(get_shadow_stack_ptr)</span></span></span><br><span class="line"><span class="params"><span class="function">		     : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 27 lock_slowpath(lock, cst)</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  ret_val = __komb_spin_lock_slowpath(lock);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 28 switch_from_ephemeral_stack(cst.node) # Ephemeral → main stack</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="keyword">if</span> (ret_val) &#123;  <span class="comment">// <span class="doctag">TODO:</span> what is ret_val?</span></span><br><span class="line">		<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;callq %P0\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;movq (%%rax), %%rsp\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%r15\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%r14\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%r13\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%r12\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%rbx\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%rbp\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;retq\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     :</span></span></span><br><span class="line"><span class="params"><span class="function">			     : <span class="string">&quot;i&quot;</span>(get_shadow_stack_ptr)</span></span></span><br><span class="line"><span class="params"><span class="function">			     : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="string">&quot;callq %P0\n&quot;</span></span><br><span class="line">			     <span class="string">&quot;movq %%rsp, (%%rax)\n&quot;</span></span><br><span class="line">			     :</span><br><span class="line">			     : <span class="string">&quot;i&quot;</span>(get_shadow_stack_ptr)</span><br><span class="line">			     : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">		<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;callq %P0\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;movq %c1(%%rax), %%rsp\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     :</span></span></span><br><span class="line"><span class="params"><span class="function">			     : <span class="string">&quot;i&quot;</span>(get_komb_node),</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="string">&quot;i&quot;</span>(offsetof(struct komb_node, rsp))</span></span></span><br><span class="line"><span class="params"><span class="function">			     : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">		<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;popq %%r15\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%r14\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%r13\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%r12\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%rbx\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;popq %%rbp\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="string">&quot;retq\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">			     :</span></span></span><br><span class="line"><span class="params"><span class="function">			     :</span></span></span><br><span class="line"><span class="params"><span class="function">			     : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="lock-slowpath"><a href="#lock-slowpath" class="headerlink" title="lock_slowpath"></a>lock_slowpath</h2><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/2023/screencapture2023-09-14 PM3.03.57.jpg"
                      width=500
                >

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">__komb_spin_lock_slowpath(struct qspinlock *lock)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">komb_node</span> *<span class="title">curr_node</span>;</span></span><br><span class="line">	<span class="keyword">int</span> tail, idx;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get qnode</span></span><br><span class="line">	curr_node = this_cpu_ptr(&amp;komb_nodes[<span class="number">0</span>]);</span><br><span class="line">	idx = curr_node-&gt;count++;</span><br><span class="line">	tail = encode_tail(smp_processor_id(), idx);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize waiter&#x27;s qnode</span></span><br><span class="line">	curr_node-&gt;locked = <span class="literal">true</span>;</span><br><span class="line">	curr_node-&gt;completed = <span class="literal">false</span>;</span><br><span class="line">	curr_node-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	curr_node-&gt;tail = tail;</span><br><span class="line">	curr_node-&gt;socket_id = numa_node_id();</span><br><span class="line">	curr_node-&gt;cpuid = smp_processor_id();</span><br><span class="line">	curr_node-&gt;irqs_disabled = <span class="literal">false</span>;</span><br><span class="line">	curr_node-&gt;lock = lock;</span><br><span class="line">	curr_node-&gt;task_struct_ptr = current;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> __komb_spin_lock_longjmp(lock, tail, curr_node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Phase-1"><a href="#Phase-1" class="headerlink" title="Phase 1"></a>Phase 1</h3><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/2023/screencapture2023-09-14 PM3.04.48.jpg"
                      width=500
                >

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">__komb_spin_lock_longjmp(struct qspinlock *lock, <span class="keyword">int</span> tail,</span><br><span class="line">			 <span class="keyword">register</span> struct komb_node *curr_node)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">register</span> <span class="class"><span class="keyword">struct</span> <span class="title">komb_node</span> *<span class="title">prev_node</span> =</span> <span class="literal">NULL</span>, *next_node = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">qspinlock</span> *<span class="title">parent_lock</span>;</span></span><br><span class="line">	<span class="keyword">int</span> old_tail, val, j;</span><br><span class="line">  <span class="keyword">uint32_t</span> prev_cs_cpu;</span><br><span class="line">	<span class="keyword">bool</span> prev_locked_val;</span><br><span class="line">	<span class="keyword">uint64_t</span> prev_rsp;</span><br><span class="line">	<span class="keyword">uint64_t</span> prev_counter_val;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">komb_node</span> *<span class="title">prev_next_node_ptr</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 36 qprev = SWAP(&amp;lock.tail, &amp;qnode) </span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="comment">// Add node to tail</span></span><br><span class="line">  old_tail = xchg_tail(lock, tail);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// If queue is not empty</span></span><br><span class="line">	<span class="keyword">if</span> (old_tail &amp; _Q_TAIL_MASK) &#123;</span><br><span class="line">    <span class="comment">// Add qnode to tail</span></span><br><span class="line">		prev_node = decode_tail(old_tail);</span><br><span class="line">		prev_node-&gt;next = curr_node;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 39 while qnode.wait is True:</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">		<span class="comment">// Wait on qnode.wait</span></span><br><span class="line">		smp_cond_load_relaxed_sched(&amp;curr_node-&gt;locked, !(VAL));</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">shadow_stack</span> *<span class="title">ptr</span> =</span> this_cpu_ptr(&amp;local_shadow_stack);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 41 if qnode.request == PRCSD :</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="comment">// Check if request has been processed (critical section executed by combiner)</span></span><br><span class="line">		<span class="keyword">if</span> (curr_node-&gt;completed) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Phase 2</span></span><br><span class="line">  ...</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// Phase 3</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Phase-2"><a href="#Phase-2" class="headerlink" title="Phase 2"></a>Phase 2</h3><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/2023/screencapture2023-09-14 PM3.05.06.jpg"
                      width=500
                >

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Now waiter is at the head of the queue</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * we&#x27;re at the head of the waitqueue, wait for the owner &amp; pending to</span></span><br><span class="line"><span class="comment"> * go away.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * *,x,y -&gt; *,0,0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * this wait loop must use a load-acquire such that we match the</span></span><br><span class="line"><span class="comment"> * store-release that clears the locked bit and create lock</span></span><br><span class="line"><span class="comment"> * sequentiality; this is because the set_locked() function below</span></span><br><span class="line"><span class="comment"> * does not imply a full barrier.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// Want to read &amp;lock-&gt;val</span></span><br><span class="line"><span class="comment">// !(VAL &amp; _Q_LOCKED_PENDING_MASK) is a condition</span></span><br><span class="line"><span class="comment">// when condition is true, read the value and save it to val</span></span><br><span class="line">val = atomic_cond_read_acquire(&amp;lock-&gt;val,</span><br><span class="line">             !(VAL &amp; _Q_LOCKED_PENDING_MASK));</span><br></pre></td></tr></table></figure>

<p>TODO: load acquire?</p>
<h3 id="Phase-3"><a href="#Phase-3" class="headerlink" title="Phase 3"></a>Phase 3</h3><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/2023/screencapture2023-09-14 PM3.05.24.jpg"
                      width=500
                >

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * claim the lock:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * n,0,0 -&gt; 0,0,1 : lock, uncontended</span></span><br><span class="line"><span class="comment"> * *,*,0 -&gt; *,*,1 : lock, contended</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the queue head is the only one in the queue (lock value == tail)</span></span><br><span class="line"><span class="comment"> * and nobody is pending, clear the tail code and grab the lock.</span></span><br><span class="line"><span class="comment"> * Otherwise, we only need to grab the lock.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 52 if CAS(&amp;lock.tail, qnode, None) == qnode:</span></span><br><span class="line"><span class="comment">* 53 return # If only one in the queue, return</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">if</span> (((val &amp; _Q_TAIL_MASK) == tail) &amp;&amp;</span><br><span class="line">    atomic_try_cmpxchg_relaxed(&amp;lock-&gt;val, &amp;val, _Q_LOCKED_VAL))</span><br><span class="line">  <span class="keyword">goto</span> release; <span class="comment">/* No contention */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Either somebody is queued behind us or _Q_PENDING_VAL is set */</span></span><br><span class="line"><span class="comment">// Declare combining phase (line 63 in pesudocode)</span></span><br><span class="line">check_and_set_combiner(lock);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * contended path; wait for next if not observed yet, release.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 54 qnext = qnode.next</span></span><br><span class="line"><span class="comment">* 55 while qnext is None:</span></span><br><span class="line"><span class="comment">* 56   qnext = qnode.next</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="comment">// Wait until qnext is get</span></span><br><span class="line">smp_cond_load_relaxed_sched(&amp;curr_node-&gt;next, (VAL));</span><br><span class="line">next_node = curr_node-&gt;next;</span><br><span class="line"></span><br><span class="line">run_combiner(lock, next_node);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run_combiner(struct qspinlock *lock, struct komb_node *curr_node)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">komb_node</span> *<span class="title">next_node</span> =</span> curr_node-&gt;next;</span><br><span class="line">	<span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 58 if qnext.next == None:</span></span><br><span class="line"><span class="comment">		* 59 notify_next_queue_head(qnext) # next waiter is combiner</span></span><br><span class="line"><span class="comment">		* 60 return</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">  <span class="comment">// &lt;2 nodes in the queue, return</span></span><br><span class="line">	<span class="keyword">if</span> (next_node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		set_locked(lock);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Make this node spin on the locked variable and then it will </span></span><br><span class="line"><span class="comment">		 * become the combiner.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		curr_node-&gt;locked = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Phase 4</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Phase-4"><a href="#Phase-4" class="headerlink" title="Phase 4"></a>Phase 4</h3><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/2023/screencapture2023-09-14 PM3.48.12.jpg"
                      width=500
                >

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shadow_stack</span> *<span class="title">ptr</span> =</span> this_cpu_ptr(&amp;local_shadow_stack);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Declare combining phase already done in Phase 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 65 while True: # Combiner loop</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">while</span> (curr_node) &#123;</span><br><span class="line">  counter++;</span><br><span class="line">  next_node = get_next_node(curr_node);</span><br><span class="line">  execute_cs(lock, curr_node);</span><br><span class="line">  clear_locked_set_completed(curr_node);</span><br><span class="line">  <span class="keyword">if</span> (next_node == <span class="literal">NULL</span> || next_node-&gt;next == <span class="literal">NULL</span> ||</span><br><span class="line">      counter &gt;= komb_batch_size)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  curr_node = next_node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Combining phase over, set lock, run its own critical section</span></span><br><span class="line">set_locked(lock);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Make this node spin on the locked variable and then it will become </span></span><br><span class="line"><span class="comment"> * the combiner.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">next_node-&gt;locked = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<h2 id="spin-unlock"><a href="#spin-unlock" class="headerlink" title="spin_unlock"></a>spin_unlock</h2><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/2023/screencapture2023-09-14 PM3.51.31.jpg"
                      width=500
                >

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">komb_spin_unlock(struct qspinlock *lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Not in combining phase, unlock and return</span></span><br><span class="line">	<span class="keyword">if</span> (lock-&gt;locked == _Q_LOCKED_VAL ||</span><br><span class="line">	    lock-&gt;locked == _Q_LOCKED_IRQ_VAL) &#123;</span><br><span class="line">		lock-&gt;locked = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">shadow_stack</span> *<span class="title">ptr</span> =</span> this_cpu_ptr(&amp;local_shadow_stack);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">komb_node</span> *<span class="title">curr_node</span> =</span> per_cpu_ptr(&amp;komb_nodes[<span class="number">0</span>], from_cpuid);</span><br><span class="line">	incoming_rsp_ptr = &amp;(ptr-&gt;local_shadow_stack_ptr);</span><br><span class="line">	outgoing_rsp_ptr = &amp;(curr_node-&gt;rsp);</span><br><span class="line">  </span><br><span class="line">	<span class="comment">// Jumo back to combiner</span></span><br><span class="line">	komb_context_switch(incoming_rsp_ptr, outgoing_rsp_ptr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Global-lock"><a href="#Global-lock" class="headerlink" title="Global lock"></a>Global lock</h1><h2 id="Lock-struct"><a href="#Lock-struct" class="headerlink" title="Lock struct"></a>Lock struct</h2><p>Top level lock, MCS queue</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">orig_qspinlock</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">      <span class="keyword">atomic_t</span> val;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        u8 locked;</span><br><span class="line">        u8 pending;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        u16 locked_pending;</span><br><span class="line">        u16 tail;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Acquire"><a href="#Acquire" class="headerlink" title="Acquire"></a>Acquire</h2><h3 id="In-spin-lock"><a href="#In-spin-lock" class="headerlink" title="In spin_lock()"></a>In spin_lock()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val = atomic_cmpxchg_acquire(&amp;lock-&gt;val, <span class="number">0</span>, _Q_LOCKED_VAL);</span><br><span class="line"><span class="keyword">if</span> (val == <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>

<p>Fastpath: is val == 0 , get the lock</p>
<h3 id="In-phase-2"><a href="#In-phase-2" class="headerlink" title="In phase 2"></a>In phase 2</h3><p>Now current node is notified by the previous node</p>
<p>Its CS is not executed</p>
<p>Wants to aquire global lock</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * we&#x27;re at the head of the waitqueue, wait for the owner &amp; pending to</span></span><br><span class="line"><span class="comment"> * go away.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * *,x,y -&gt; *,0,0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * this wait loop must use a load-acquire such that we match the</span></span><br><span class="line"><span class="comment"> * store-release that clears the locked bit and create lock</span></span><br><span class="line"><span class="comment"> * sequentiality; this is because the set_locked() function below</span></span><br><span class="line"><span class="comment"> * does not imply a full barrier.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">val = atomic_cond_read_acquire(&amp;lock-&gt;val, !(VAL &amp; _Q_LOCKED_PENDING_MASK));</span><br></pre></td></tr></table></figure>

<p>Since</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> atomic_cond_read_acquire(v, c) smp_cond_load_acquire(&amp;(v)-&gt;counter, (c))</span></span><br></pre></td></tr></table></figure>

<p>This actucally calls smp_cond_load_acquire()</p>
<p>-&gt; refer to: <a class="link"   target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/core-api/wrappers/memory-barriers.html" >https://www.kernel.org/doc/html/latest/core-api/wrappers/memory-barriers.html<i class="fas fa-external-link-alt"></i></a></p>
<p>When lock is not pending, read lock value, add ACQUIRE barrier?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * set_locked - Set the lock bit and own the lock</span></span><br><span class="line"><span class="comment"> * @lock: Pointer to queued spinlock structure</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * *,*,0 -&gt; *,0,1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> <span class="title">set_locked</span><span class="params">(struct qspinlock *lock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	WRITE_ONCE(lock-&gt;locked, _Q_LOCKED_VAL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>…reading <a class="link"   target="_blank" rel="noopener" href="https://deepdives.medium.com/kernel-locking-deep-dive-into-spinlocks-part-1-bcdc46ee8df6" >https://deepdives.medium.com/kernel-locking-deep-dive-into-spinlocks-part-1-bcdc46ee8df6<i class="fas fa-external-link-alt"></i></a></p>

        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2023/10/02/lock-debug/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Switch lock debug</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2023/01/08/tcpip/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">TCP/IP复习</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>&nbsp;-&nbsp;
            
            2023&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">coconutnut</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Repo-structure"><span class="nav-number">1.</span> <span class="nav-text">Repo structure</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TCLock-implementation"><span class="nav-number">2.</span> <span class="nav-text">TCLock implementation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#spin-lock"><span class="nav-number">2.1.</span> <span class="nav-text">spin_lock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#switch-stack"><span class="nav-number">2.2.</span> <span class="nav-text">switch_stack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lock-slowpath"><span class="nav-number">2.3.</span> <span class="nav-text">lock_slowpath</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Phase-1"><span class="nav-number">2.3.1.</span> <span class="nav-text">Phase 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Phase-2"><span class="nav-number">2.3.2.</span> <span class="nav-text">Phase 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Phase-3"><span class="nav-number">2.3.3.</span> <span class="nav-text">Phase 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Phase-4"><span class="nav-number">2.3.4.</span> <span class="nav-text">Phase 4</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#spin-unlock"><span class="nav-number">2.4.</span> <span class="nav-text">spin_unlock</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Global-lock"><span class="nav-number">3.</span> <span class="nav-text">Global lock</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Lock-struct"><span class="nav-number">3.1.</span> <span class="nav-text">Lock struct</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Acquire"><span class="nav-number">3.2.</span> <span class="nav-text">Acquire</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#In-spin-lock"><span class="nav-number">3.2.1.</span> <span class="nav-text">In spin_lock()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#In-phase-2"><span class="nav-number">3.2.2.</span> <span class="nav-text">In phase 2</span></a></li></ol></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
